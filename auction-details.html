<!doctype html>
<html lang="en">
  <head>
    <title>AutoBid</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="assets/images/AutoBid logo.png" type="image/gif" sizes="20x20">
    <link rel="stylesheet" href="assets/css/swiper-bundle.min.css">
    <link rel="stylesheet" href="assets/css/boxicons.min.css">
    <link rel="stylesheet" href="assets/css/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/magnific-popup.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/responsive.css">
  </head>
  <body>
    <div class="preloader">
      <div class="loader">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
    <header>
      <div class="header-area header-style-one px-md-5">
        <div class="container-fluid">
          <div class="row">
            <div class="col-xl-2 align-items-center d-xl-flex d-lg-block">
              <div class="nav-logo d-flex justify-content-between align-items-center">
                <a href="index.html"><img src="assets/images/AutoBid logo.png"style="width: 60px;" alt="logo"></a>
                <div class="d-flex align-items-center gap-4">
                  <ul class="nav-actions nav-inner-actions d-flex d-xl-none">
                    <li class="header-account me-0 position-relative">
                      <a href="login.html" id="dropdownMenu4" data-bs-toggle="dropdown">
                        <i class="bi bi-person-fill"></i>
                      </a>
                      <ul class="dropdown-menu account-list-mobile" aria-labelledby="dropdownMenu4">
                        <li class="dropdown-item"><a href="login.html">My account</a></li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-xl-5">
              <nav class="main-nav">
                <div class="inner-logo d-xl-none text-center mt-4">
                  <a href="#"><img src="assets/images/logo-dark.png" alt></a>
                </div>
                <ul>
                  <li>
                    <a href="index.html">Home</a>
                  </li>
                  
                  <li>
                    <a href="auction.html">Auction</a>
                  </li>
                  <li class="has-child-menu">
                    <a href="javascript:void(0)">Pages</a>
                    <i class="fl flaticon-plus">+</i>
                    <ul class="sub-menu">
                      <li><a href="about.html">about</a></li>
                      <li><a href="privacy.html">Privacy Policy</a></li>
                    </ul>
                  </li>
                  <li><a href="contact.html">contact</a></li>
                </ul>
              </nav>
            </div>
            <div class="col-xl-5 d-xl-flex align-items-center justify-content-end d-none">
              <div class="nav-right d-flex align-items-center">
                <div class="nav-actions d-flex align-items-center">
                  <ul class="d-flex">
                    <li class="search-btn d-block d-xxl-none"><i class="bi bi-search"></i></li>
                    <li class="header-account me-0 position-relative">
                      <a id="dropdownMenu2" data-bs-toggle="dropdown">
                        <i class="bi bi-person-fill"></i>
                      </a>
                      <ul class="dropdown-menu account-list" aria-labelledby="dropdownMenu2">
                        <li class="dropdown-item"><a href="MyAccount.html">My account</a></li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="breadcrumb breadcrumb-style-one mb-0 ">
      <div class="container">
        <div class="col-lg-12 text-center">
          <h1 class="breadcrumb-title">Auction Details</h1>
          <ul class="d-flex justify-content-center breadcrumb-items">
            <li class="breadcrumb-item"><i class="bi bi-house-door"></i> <a href="index.html">Home</a></li>
            <li class="breadcrumb-item active">Auction Details</li>
          </ul>
        </div>
      </div>
    </div>
    <section class="auction-details-section pt-110">
      <div class="container">
        <div class="row gy-5">
          <div class="col-lg-6">
            <div class="item-bid-timer">
              <div class="auction-bid">
                <p>Current Bid</p>
                <h5>LKR <span id="auction-current-bid"></span></h5> 
            </div>
            
              <div class="auction-timer">
                <div class="countdown" id="timer4">
                  <h6><div id="timer"></div></h6></div>
              </div>
            </div>
            <div class="tab-content">
              <div class="tab-pane big-image fade show active" id="gallery-img1">
                
                
                <img id="auction-image" src="" alt="Auction Image">
              </div>
            </div>
            <ul class="nav small-image-list d-flex justify-content-md-between justify-content-center gap-md-4 gap-2">
            </ul>
            <div class="item-describe-area">
            </div>
          </div>
          <div class="col-lg-6">
            <div class="widget-right-area">
              <h2><span id="auction-title"></span></h2>
              <p class="paragraph" ></p>
              <div class="single-widget">
                <h5 class="wdget-title">Product Overview</h5>
                <ul class="widget-list">
                  <li>EndTime:<span id="auction-end-time"></span></li>
                  <li><span id="auction-description"></span></li>
                  
                </ul>
              </div>
              <div class="single-widget">
                <h5 class="wdget-title wdget-title2">Bid Now</h5>
                <form class="widget-form" id="bid-form">
                  <div class="form-group d-flex justify-content-center align-items-center">
                      <input type="number" id="bid-amount" placeholder="$00.00" required step="0.01">
                      <button type="submit" class="widget-btn">Place Bid</button>
                  </div>
              </form>              
              
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <br>
    
    <!--Footer Part-->

    <footer class="footer-area footer-style-one">
      <div class="container">
        <div class="footer-main">
          <div class="row gy-5">
            <div class="col-lg-4">
              <div class="footer-widget">
                <form action="#" id="subscribe_form">
                  <h3 class="form-title">subscribe us</h3>
                  <div class="form-wrap d-flex align-items-center">
                    <input type="email" placeholder="Enter Your Email">
                    <button type="submit">Send</button>
                  </div>
                </form>
                <div class="footer-contact-links">
                  <div class="contact-option">
                    <div class="icon">
                      <i class="bi bi-telephone-plus"></i>
                    </div>
                    <div class="link">
                      <a href="tel:+94769423847">+94 76 942 3847</a>
                    </div>
                  </div>
                  <div class="contact-option">
                    <div class="icon">
                      <i class="bi bi-envelope"></i>
                    </div>
                    <div class="link">
                      <a href="sandithkariyawasam2001@gmail.com">sandithkariyawasam2001@gmail.com</a>
                    </div>
                  </div>
                  <div class="contact-option">
                    <div class="icon">
                      <i class="bi bi-geo-alt"></i>
                    </div>
                    <div class="link">
                      <a href="tel:8801761111456">Alubomulla,Panadura,Sri Lanka</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="row gy-5">
                <div class="col-md-6 col-sm-6 d-flex justify-content-lg-center">
                  <div class="footer-widget">
                    <h5 class="widget-title">Quick Links</h5>
                    <ul class="widget-links">
                      <li><a href="login.html">My Account</a></li>
                      <li><a href="privacy.html">Privacey Policy</a></li>
                    </ul>
                  </div>
                </div>
                <div class="col-md-6 col-sm-6 d-flex justify-content-lg-center">
                  <div class="footer-widget">
                    <h5 class="widget-title">Help Center</h5>
                    <ul class="widget-links">
                      <li><a href="contact.html">Help Center</a></li>
                      <li><a href="auction.html">Sell your Product</a></li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="footer-widget text-center text-lg-start">
                <div class="footer-disc">
                  <a href="index.html"><img src="assets/images/AutoBid logo.png"  alt></a>
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>

   
    <script>
      document.addEventListener('DOMContentLoaded', function () {
          // Function to get auctionId from URL
          function getAuctionIdFromUrl() {
              const urlParams = new URLSearchParams(window.location.search);
              return urlParams.get('auctionId'); // Get auctionId from URL query string
          }
  
          // Function to fetch auction details by ID
          function fetchAuctionDetails(auctionId) {
              const accessToken = localStorage.getItem('jwtToken'); // Get the access token
  
              fetch(`https://localhost:7047/api/Auction/${auctionId}`, {
                  method: 'GET',
                  headers: {
                      'Authorization': `Bearer ${accessToken}`
                  }
              })
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.json(); // Parse JSON response
              })
              .then(data => {
                  // Populate HTML with auction details
                  document.getElementById('auction-title').innerText = data.title;
                  document.getElementById('auction-description').innerText = data.description;
                  document.getElementById('auction-image').src = data.auctionImage;
  
                  // Set up timer using the end time from data
                  const endTime = new Date(data.endTime).getTime(); // Convert to timestamp
                  document.getElementById('auction-end-time').innerText = new Date(data.endTime).toLocaleString(); // Display in locale format
                  makeTimer(endTime); // Call timer function with end time
  
                  // Fetch the current bid amount after getting auction details
                  fetchCurrentBid(data.vehicleId);
              })
              .catch(error => {
                  console.error('Error fetching auction details:', error);
                  alert('Could not fetch auction details. Please try again later.');
              });
          }
  
          // Function to fetch current bid amount
          function fetchCurrentBid(vehicleId) {
              const accessToken = localStorage.getItem('jwtToken'); // Get the access token
  
              return fetch(`https://localhost:7047/api/Bid`, {
                  method: 'GET',
                  headers: {
                      'Authorization': `Bearer ${accessToken}`
                  }
              })
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.json();
              })
              .then(data => {
                  // Find the current bid for the specific vehicleId
                  const currentBid = data.find(bid => bid.vehiucleId === vehicleId);
                  const bidAmount = currentBid ? currentBid.BidAmount : 0;
                  document.getElementById('auction-current-bid').innerText = bidAmount; // Display current bid amount
                  return bidAmount; // Return current bid amount
              })
              .catch(error => {
                  console.error('Error fetching current bid:', error);
              });
          }
  
          // Function to create a new bid
          function createBid(vehicleId, bidAmount) {
              const accessToken = localStorage.getItem('jwtToken'); // Get the access token
              const bidData = {
                  vehiucleId: vehicleId,
                  BidAmount: bidAmount
              };
  
              fetch(`https://localhost:7047/api/Bid/create`, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${accessToken}`,
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(bidData)
              })
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.json();
              })
              .then(data => {
                  // After creating a bid, fetch the updated current bid
                  fetchCurrentBid(vehicleId);
  
                  // Refresh the page after placing the bid
                  window.location.reload(); // Reload the page to reflect changes
              })
              .catch(error => {
                  console.error('Error creating bid:', error);
                  alert('Could not place bid. Please try again later.');
              });
          }
  
          // Timer function
          function makeTimer(endTime) {
              const timerElement = document.getElementById('timer'); // Ensure you have an element with this ID to show the countdown
  
              function updateTimer() {
                  const now = new Date().getTime(); // Current time
                  const timeLeft = endTime - now; // Time left in milliseconds
  
                  // Calculate days, hours, minutes, seconds
                  const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                  const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                  const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                  const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
  
                  // Update the timer element
                  timerElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
  
                  // If the countdown is over, display a message
                  if (timeLeft < 0) {
                      clearInterval(timerInterval);
                      timerElement.innerHTML = "Auction has ended"; // Change this as needed
                  }
              }
  
              // Update the timer every second
              const timerInterval = setInterval(updateTimer, 1000);
              updateTimer(); // Initial call to display the timer immediately
          }
  
          // Handle the form submission
          const bidForm = document.getElementById('bid-form');
          bidForm.addEventListener('submit', function (event) {
              event.preventDefault(); // Prevent form submission
              const bidAmount = parseFloat(document.getElementById('bid-amount').value);
              const auctionId = getAuctionIdFromUrl();
  
              if (auctionId && !isNaN(bidAmount) && bidAmount > 0) {
                  const vehicleId = auctionId; // Assign auctionId to vehicleId
  
                  // Fetch the current bid and then compare
                  fetchCurrentBid(vehicleId).then(currentBid => {
                      if (bidAmount > currentBid) {
                          createBid(vehicleId, bidAmount); // Create a new bid
                      } else {
                          alert('Your bid must be higher than the current bid.');
                      }
                  }).catch(error => {
                      console.error('Error fetching the current bid:', error);
                      alert('Could not fetch current bid. Please try again later.');
                  });
              } else {
                  alert('Please enter a valid bid amount.');
              }
          });
  
          // Get auctionId from the URL and fetch auction details
          const auctionId = getAuctionIdFromUrl();
          if (auctionId) {
              fetchAuctionDetails(auctionId);
          } else {
              console.error('Auction ID not found in the URL');
              alert('Auction ID not found.');
          }
      });
  </script>
  
    
  
    <script src="assets/js/jquery-3.6.0.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/swiper-bundle.min.js"></script>
    <script src="assets/js/jquery.magnific-popup.min.js"></script>
    <script src="assets/js/jquery.nice-select.js"></script>
    <script src="assets/js/main.js"></script>
  </body>
</html>